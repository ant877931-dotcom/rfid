<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin Presensi RFID</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        :root { 
            --primary: #2563eb; 
            --bg: #f8fafc; 
            --text: #1e293b; 
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); padding: 20px; margin: 0; }
        .container { max-width: 1200px; margin: 0 auto; display: flex; flex-direction: column; gap: 20px; }
        
        /* HEADER */
        .header { background: white; padding: 20px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        h1 { margin: 0; color: var(--primary); font-size: 1.5rem; }
        
        /* STATS */
        .stats-row { display: flex; gap: 20px; }
        .stat-card { flex: 1; background: white; padding: 24px; border-radius: 12px; text-align: center; border-bottom: 4px solid #cbd5e1; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .stat-card h3 { margin: 0 0 10px 0; font-size: 0.85rem; color: #64748b; text-transform: uppercase; letter-spacing: 1px; }
        .stat-card p { margin: 0; font-size: 2.5rem; font-weight: 800; color: #1e293b; }
        
        /* CHART & TABLE */
        .content-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }
        .box { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .chart-container { height: 300px; position: relative; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { background: #f1f5f9; text-align: left; padding: 12px; font-size: 0.85rem; color: #64748b; text-transform: uppercase; }
        td { padding: 12px; border-bottom: 1px solid #e2e8f0; font-size: 0.95rem; }
        
        /* BADGES - PENTING: Default Abu-abu agar ketahuan kalau error */
        .badge { padding: 5px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; display: inline-block; min-width: 80px; text-align: center; }
        .bg-green { background: #dcfce7; color: #166534; }  /* Tepat Waktu */
        .bg-red   { background: #fee2e2; color: #991b1b; }  /* Terlambat */
        .bg-grey  { background: #f1f5f9; color: #64748b; }  /* Tidak Jelas */

        /* CONTROLS */
        .controls { display: flex; gap: 10px; }
        button { padding: 10px 16px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: 0.2s; }
        .btn-active { background: var(--primary); color: white; }
        .btn-inactive { background: white; border: 1px solid #cbd5e1; color: #64748b; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div>
            <h1>Dashboard Presensi</h1>
            <small id="debug-info" style="color: #64748b; font-family: monospace;">Memuat konfigurasi...</small>
        </div>
        <div id="clock" style="font-weight: bold; font-size: 1.2rem;">--:--:--</div>
    </div>

    <div class="stats-row">
        <div class="stat-card" style="border-color: #22c55e;">
            <h3>Hadir (Tepat Waktu)</h3>
            <p id="statTepat" style="color: #166534;">0</p>
        </div>
        <div class="stat-card" style="border-color: #ef4444;">
            <h3>Terlambat</h3>
            <p id="statTelat" style="color: #991b1b;">0</p>
        </div>
        <div class="stat-card" style="border-color: #3b82f6;">
            <h3>Total Hadir</h3>
            <p id="statTotal">0</p>
        </div>
    </div>

    <div class="controls">
        <button onclick="fetchData('hari', this)" class="btn-active">Hari Ini</button>
        <button onclick="fetchData('minggu', this)" class="btn-inactive">Minggu Ini</button>
        <button onclick="fetchData('bulan', this)" class="btn-inactive">Bulan Ini</button>
        <div style="flex-grow:1"></div>
        <button onclick="exportExcel()" style="background: #10b981; color: white;">Excel</button>
    </div>

    <div class="content-grid">
        <div class="box">
            <h3 style="margin-top:0;">Log Kehadiran</h3>
            <div style="overflow-x:auto;">
                <table id="mainTable">
                    <thead>
                        <tr>
                            <th>Jam</th>
                            <th>Nama</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>

        <div class="box">
            <h3 style="margin-top:0; text-align:center;">Proporsi</h3>
            <div class="chart-container">
                <canvas id="doughnutChart"></canvas>
            </div>
        </div>
    </div>
</div>

<script>
    // 1. CONFIG
    const SUPABASE_URL = 'https://yoxipkgpxhavmxknlwft.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_nGr7Fit3oX6dF4WcNPOq9g_AFpTcezy';
    const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // Variabel Global
    let BATAS_TELAT = "08:15:00"; 
    let globalData = [];
    let myChart = null;

    // Jam Realtime
    setInterval(() => document.getElementById('clock').innerText = new Date().toLocaleTimeString('id-ID'), 1000);

    // 2. LOGIC UTAMA
    async function fetchData(range, btn) {
        // UI Update
        if(btn) {
            document.querySelectorAll('button').forEach(b => {
                if(b.innerText === 'Hari Ini' || b.innerText === 'Minggu Ini' || b.innerText === 'Bulan Ini') {
                    b.className = 'btn-inactive';
                }
            });
            btn.className = 'btn-active';
        }

        // A. AMBIL BATAS JAM DARI DB
        const hariIni = new Date().getDay() || 7; 
        const { data: setting } = await client.from('pengaturan_absen').select('batas_terlambat').eq('hari_id', hariIni).single();
        if(setting) BATAS_TELAT = setting.batas_terlambat;
        
        // Tampilkan info debug di header
        document.getElementById('debug-info').innerText = `Batas Telat Hari Ini: ${BATAS_TELAT}`;

        // B. QUERY DATA
        let query = client.from('presensi').select('*, karyawan(nama)');
        const today = new Date().toISOString().split('T')[0];
        
        if(range === 'hari') query = query.eq('tanggal', today);
        else if(range === 'minggu') {
            const d = new Date(); d.setDate(d.getDate()-7);
            query = query.gte('tanggal', d.toISOString());
        }

        const { data, error } = await query.order('jam_masuk', {ascending: false});
        if(error) return alert("Gagal ambil data");

        // C. PROSES HITUNG ULANG (RE-CALCULATE)
        // Kita tidak percaya 100% pada kolom status DB, kita hitung ulang biar konsisten
        globalData = (data || []).map(d => {
            let status = 'Tepat Waktu';
            
            // Logika: Jika ada jam masuk, dan jam masuk > batas telat -> TERLAMBAT
            if(d.jam_masuk) {
                // Bandingkan string jam "15:49" > "08:15"
                if(d.jam_masuk > BATAS_TELAT) {
                    status = 'Terlambat';
                }
            } else {
                status = '-';
            }

            return { ...d, computed_status: status };
        });

        renderAll();
    }

    function renderAll() {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';

        let countTepat = 0;
        let countTelat = 0;

        globalData.forEach(d => {
            // Hitung Stats
            if(d.computed_status === 'Terlambat') countTelat++;
            else if(d.computed_status === 'Tepat Waktu') countTepat++;

            // Render Tabel
            let badgeColor = 'bg-grey';
            if(d.computed_status === 'Tepat Waktu') badgeColor = 'bg-green';
            if(d.computed_status === 'Terlambat') badgeColor = 'bg-red';

            const jam = d.jam_masuk ? d.jam_masuk.substring(0, 5) : '-';
            const nama = d.karyawan ? d.karyawan.nama : 'Unknown';

            tbody.innerHTML += `
                <tr>
                    <td style="font-family:monospace; font-weight:bold;">${jam}</td>
                    <td>${nama}</td>
                    <td><span class="badge ${badgeColor}">${d.computed_status}</span></td>
                </tr>
            `;
        });

        // Render Stats Text
        document.getElementById('statTepat').innerText = countTepat;
        document.getElementById('statTelat').innerText = countTelat;
        document.getElementById('statTotal').innerText = globalData.length;

        // Render Chart
        if(myChart) myChart.destroy();
        const ctx = document.getElementById('doughnutChart').getContext('2d');
        
        // Debug: Jika chart kosong/aneh, pastikan array data tidak [0,0]
        const chartData = [countTepat, countTelat];
        
        myChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Tepat Waktu', 'Terlambat'],
                datasets: [{
                    data: chartData,
                    backgroundColor: ['#22c55e', '#ef4444'], // Hijau, Merah
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });
    }

    // Export Excel Sederhana
    function exportExcel() {
        if(!globalData.length) return alert("Data Kosong");
        const ws = XLSX.utils.json_to_sheet(globalData.map(d => ({
            Tanggal: d.tanggal,
            Nama: d.karyawan?.nama,
            Jam_Masuk: d.jam_masuk,
            Status_Hitungan: d.computed_status
        })));
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Presensi");
        XLSX.writeFile(wb, "Laporan.xlsx");
    }

    // Init Load
    fetchData('hari', document.querySelector('.btn-active'));

</script>

</body>
</html>
